# Instructions for Offline Policy Evaluation

## Requirements

1. Python 3.10.0
2. EnergyPlus 9.3.0
3. miniconda3 (optional)

## Installation

We recommend using a virtual environment before installing the required packages to avoid conflicts with other projects.

```bash
conda create -n building_control python=3.10.0
conda activate building_control
```

Run the following commands to install the required packages.

```bash
pip install -r requirements.txt
```

## Usage

### 1. Offline Off-Policy Policy Evaluation

#### Prerequisites

1. The trained policies in the policy library placed under the `./policy_library` directory

#### 1.1. Dataset preparation

To run offline policy evaluation, log data generated by the default building controller must be provided. This data should be in a CSV format and contain the following fields,

- `timestep`: The current timestep
- `zone name`: The name of the zone
- `outdoor_temp`: The outdoor temperature
- `solar_irradiation`: The solar irradiation
- `time_hour`: The time of day in hour (0-24)
- `zone_humidity`: The humidity in the zone
- `zone_temp`: The temperature in the zone
- `zone_occupancy`: The number of occupants in the zone
- `action`: The action taken to set the minimum damper position in the zone
- `reward`: The reward received at this timestep
- `outdoor_temp_tp1`: The outdoor temperature in the next timestep
- `solar_irradiation_tp1`: The solar irradiation in the next timestep
- `time_hour_tp1`: The time of day in hours (0-24) for the next timestep
- `zone_humidity_tp1`: The humidity in the zone in the next timestep
- `zone_temp_tp1`: The zone temperature in the zone in the next timestep
- `zone_occupancy_tp1`: The number of occupants in the zone in the next timestep

The CSV file can be placed in the `data/rule_based_log_data/<name_of_building>/log_data.csv`.

Next, go through `studies/rule_based_log_data_analysis.ipynb` to analyze the actions taken by the rule based log data, and to generate the action and state transition probabilities for the rule-based policy in order to run offline off-policy policy evaluation in the next steps.

#### 1.2. Different OPE metrics

Offline Off-Policy Evaluation is split into two notebooks. One for the discrete setting, and one for the continuous setting.

For the discrete setting, please refer to the `studies/discrete_ope.ipynb` notebook to run OPE and generate the raw scores used for policy clustering later on.

For the continuous setting, please refer to the `studies/continuous_ope.ipynb` notebook.

#### 1.3. Different ZCPs Metrics

For NAS inspired Zero Cost Proxy (ZCP) based offline off-policy policy evaluation, please refer to the `studies/zcp_based_ope.ipynb` notebook to run OPE and generate the raw scores for policy clustering later on.

1.4. Seeing Analysis and Comparison

### 2. Online Policy Evaluation (UCB)

#### 2.1. UCB Preparation

For running the UCB algorithm for policy selection, the zones in the building must be grouped in terms of similarity. This can be based on the location of the zones in the building, or based on the insulation materials, and other properties.

Once these groups are identified, each group can be assigned some policies. Unfortunately all the policies from the policy library cannot be used as the number of arms to represent all the possible assignment combinations grows exponentially. Instead sticking to the top-3 or top-5 policies for each zone group is recommended.

In `group_ucb_evaluation.py`, under the `if __name__ == "__main__"` condition, there are three group configurations and policies for the three building environments we had tested in this work.

#### 2.2. Running UCB

`group_ucb_evaluation.py` is the file that executes UCB for the specified building environment. This module is called by running the following command (without the <>),

```bash
python group_ucb_evaluation.py <seed_number> <building_name>
```

For reproducibility, multiple instances of the above command can be run with different seeds to speed up the process as each UCB run is independent of the other.

#### 2.3. Analyzing UCB

The log data generated by the UCB algorithm will be saved in the location specified under the `log_dir` argument of the `GroupedUCB` class.

The log data saved is in the form of a CSV file, where information such as the energy consumption of each arm pull for each timestep, as well as the arm counts, and arm scores are all logged. This can be used to see if the energy consumption of the UCB algorithm decreases over time. This information can be used to compare the performance of UCB with the our proposed policy selection algorithm.
